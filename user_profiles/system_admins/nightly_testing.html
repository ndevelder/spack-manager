<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nightly Testing with Spack-Manager &mdash; Spack-Manager 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Frequently Asked Questions:" href="../../general/FAQ.html" />
    <link rel="prev" title="System Administrator Documentation" href="system_admins.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Spack-Manager
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../user_profiles.html">User Profiles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../analysts/analysts.html">Analysts Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developers/developers.html">Developer Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="system_admins.html">System Administrator Documentation</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Nightly Testing with Spack-Manager</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/FAQ.html">Frequently Asked Questions:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../general/general.html">General Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack-Manager</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../user_profiles.html">User Profiles</a></li>
          <li class="breadcrumb-item"><a href="system_admins.html">System Administrator Documentation</a></li>
      <li class="breadcrumb-item active">Nightly Testing with Spack-Manager</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/user_profiles/system_admins/nightly_testing.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nightly-testing-with-spack-manager">
<h1>Nightly Testing with Spack-Manager<a class="headerlink" href="#nightly-testing-with-spack-manager" title="Link to this heading"></a></h1>
<p>Spack-manager has all the necessary components implemented to test and report results for a project to CDash each night. In the following section we will be using the Exawind project as an example to explain the testing process.</p>
<section id="cron-job">
<h2>Cron Job<a class="headerlink" href="#cron-job" title="Link to this heading"></a></h2>
<p>Starting from the nightly cronjob, the Exawind testing job is invoked as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Exawind tests</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;export SPACK_MANAGER=/projects/ecp/exawind/exawind-testing/spack-manager &amp;&amp; cd \$</span><span class="si">{SPACK_MANAGER}</span><span class="s2"> &amp;&amp; \$</span><span class="si">{SPACK_MANAGER}</span><span class="s2">/scripts/update-spack-manager-repo.sh &amp;&gt; \$</span><span class="si">{SPACK_MANAGER}</span><span class="s2">/logs/last-spack-manager-repo-update.txt &amp;&amp; \$</span><span class="si">{SPACK_MANAGER}</span><span class="s2">/scripts/run-exawind-nightly-tests.sh &amp;&gt; \$</span><span class="si">{SPACK_MANAGER}</span><span class="s2">/logs/last-exawind-test-script-invocation.txt&quot;</span>
</pre></div>
</div>
<p>In the cron job specification, <code class="docutils literal notranslate"><span class="pre">SPACK_MANAGER</span></code> is set. Then the spack-manager repo used for the testing is updated each night with the changes to spack-manager so it’s always up-to-date. Next the <code class="docutils literal notranslate"><span class="pre">run-exawind-nightly-tests.sh</span></code> script is run.</p>
</section>
<section id="test-invocation">
<h2>Test Invocation<a class="headerlink" href="#test-invocation" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">run-exawind-nightly-tests.sh</span></code> script generates another script on the fly. This is done because depending on what machine it is on, it may need to submit a job to run the tests, which requires a script to be submitted. Spack-manager finds the machine it is running on and runs the generated test script using different methods for different machines.</p>
<p>For Exawind, the test script manages much of the archiving of gold files for each particular application in the <code class="docutils literal notranslate"><span class="pre">golds</span></code> directory of spack-manager. It then finds the set of tests that machine is intended to run which are listed in a file in the <code class="docutils literal notranslate"><span class="pre">env-templates</span></code> directory. These yaml files are lists of specs to be installed and tested. Spack-manager uses python class inheritance to add special testing packages with <code class="docutils literal notranslate"><span class="pre">*-nightly</span></code> suffixes onto preexisting packages within Spack or the custom spack-manager package repos in the <code class="docutils literal notranslate"><span class="pre">repos</span></code> directory. These nightly packages manage the CMake configured options that get passed to the CTest nightly scripts with the repos for each tested package. Spack-manager then sets up a Spack environment with the testing yaml file, activates the environment, uninstalls all the nightly test packages installed from the previous test runs and then concretizes and installs the latest git repos of the packages. By doing multiple <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">install</span></code> processes at the same time, Spack is able to parallelize the disjoint packages that have no dependencies on one another and test multiple packages on a system at once in a very organized and separate fashion. Once the tests complete, each package reports their own results to CDash and the test script then archives the generated gold files.</p>
</section>
<section id="snl-nightly-testing">
<h2>SNL nightly testing<a class="headerlink" href="#snl-nightly-testing" title="Link to this heading"></a></h2>
<p>Scripts for nightly testing of Nalu-Wind on Sandia machines are located in <code class="docutils literal notranslate"><span class="pre">${SPACK_MANAGER}/scripts</span></code>.
<code class="docutils literal notranslate"><span class="pre">nalu_wind_snl_cpu_nightly_test.sh</span></code> runs CPU tests, and <code class="docutils literal notranslate"><span class="pre">nalu_wind_snl_gpu_nightly_test.sh</span></code> runs GPU
tests.  The current cronjob looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="mi">22</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">wind</span><span class="o">/</span><span class="n">wind</span><span class="o">-</span><span class="n">testing</span><span class="o">-</span><span class="n">cpu</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">nalu_wind_snl_cpu_nightly_test</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Note that things can get messed up if you do one-off runs from the same Spack-Manager directory as
the regular nightly testing, so if you want to do a one-off test run, it’s best to do it from a
separate Spack-Manager instance.</p>
<section id="gold-files">
<h3>Gold files<a class="headerlink" href="#gold-files" title="Link to this heading"></a></h3>
<p>Currently, the nightly testing scripts set permissions correctly to allow anyone to access the gold
files, but they will break if anyone has written gold files besides the owner of the nightly testing
process.  For this reason, if someone else wants to build the <code class="docutils literal notranslate"><span class="pre">nalu-wind-nightly</span></code> package with the
golds generated overnight, best practice is to first copy the gold files to another location, and
point the one-off script towards this new location.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="system_admins.html" class="btn btn-neutral float-left" title="System Administrator Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../general/FAQ.html" class="btn btn-neutral float-right" title="Frequently Asked Questions:" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>